<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reservar | Odisea Challenge</title>
    <script src="https://sdk.mercadopago.com/js/v2"></script>
</head>

<body>

    <h1>Finaliza tu reserva</h1>

    <p>ID del viaje seleccionado: <strong id="display-trip-id">Cargando...</strong></p>

    <form id="form-reserva">
        <input type="text" id="nombre" placeholder="Nombre completo" required><br><br>
        <input type="email" id="email" placeholder="Correo electrónico" required><br><br>
        <input type="number" id="cantidad" value="1" min="1" required><br><br>

        <button type="submit" id="btn-confirmar">Confirmar datos y pagar</button>
    </form>

    <div id="wallet_container"></div>

    <script>
        // 1. Capturar ID de la URL
        const urlParams = new URLSearchParams(window.location.search);
        const tripId = urlParams.get('trip_id');

        if (tripId) {
            document.getElementById('display-trip-id').innerText = tripId;
        }

        // 2. Escuchar el clic del botón
        document.getElementById('form-reserva').addEventListener('submit', async (e) => {
            e.preventDefault(); // Evita que la página se recargue

            const btn = document.getElementById('btn-confirmar');
            const originalText = btn.innerText;
            btn.innerText = "Procesando...";
            btn.disabled = true;

            try {
                console.log("Iniciando reserva para trip_id:", tripId);

                // PASO A: Crear la reserva en Railway
                const resReserva = await fetch('https://api.odiseachallenge.com/reservations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        trip_id: tripId,
                        full_name: document.getElementById('nombre').value,
                        email: document.getElementById('email').value,
                        qty: parseInt(document.getElementById('cantidad').value)
                    })
                });

                if (!resReserva.ok) {
                    const errorData = await resReserva.json();
                    throw new Error(errorData.message || `Error en reserva: ${resReserva.status}`);
                }

                const reserva = await resReserva.json();
                console.log("Reserva creada:", reserva);

                if (reserva.status !== 'ok' || !reserva.reservation_token) {
                    throw new Error(reserva.message || "No se recibió token de reserva");
                }

                // PASO B: Crear la preferencia de Mercado Pago
                const resPref = await fetch('https://api.odiseachallenge.com/create-preference', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        reservation_token: reserva.reservation_token,
                        title: "Tour Odisea Challenge",
                        price: 1 // Prueba de 1 peso real
                    })
                });

                if (!resPref.ok) {
                    const errorData = await resPref.json();
                    throw new Error(errorData.message || `Error en preferencia: ${resPref.status}`);
                }

                const preferencia = await resPref.json();
                console.log("Preferencia creada:", preferencia);

                // PASO C: Abrir la pasarela de pago
                if (preferencia.init_point) {
                    window.location.href = preferencia.init_point;
                } else {
                    throw new Error("No se recibió init_point de Mercado Pago");
                }

            } catch (error) {
                console.error("Error en el proceso:", error);
                alert("Hubo un error: " + error.message);
                btn.innerText = originalText;
                btn.disabled = false;
            }
        });
    </script>
</body>

</html>